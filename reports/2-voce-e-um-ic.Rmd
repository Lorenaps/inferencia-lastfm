---
title: "Implementando ICs - L3P2: ICs via bootstrap"
author: "Lorena Pereira"
output:
  html_document:
    theme: readable
    df_print: paged
    toc: yes
  html_notebook:
    fig_width: 7
    theme: readable
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

theme_set(theme_bw())

```

## Os dados

```{r}
set.seed(12345)

lastfm = read_csv(here::here("data/experimento-lastfm.csv"), 
                  col_types = cols(.default = col_double(), 
                                   user = col_character()))

lastfm = lastfm %>% 
  sample_n(300) %>% 
  select(news, old, mediana_pop)

glimpse(lastfm)
```

## Proporção de artistas novos e popularidade

Utilizaremos ICs para estimar duas métricas sobre os usuários do LastFM em geral durante um período de 6 meses. Em ambos os casos faremos isso a partir de uma amostra de 300 usuários. As duas métricas são: 

1. Qual a proporção de novos artistas em geral escutada por usuários?
2. Para os usuários que gostam de música muito pop (mediana_pop > 5), qual a correlação entre a popularidade mediana dos artistas escutado e a proporção dos artistas escutados que eram novos. 

Crie intervalos com 95% de confiança.

### 1. Qual a proporção de novos artistas em geral escutada por usuários?

- *Função para cálculo da proporção*
```{r}

# lastfm %>% 
#   summarise(mean_news = median(news), mean_old = median(old)) %>%
#   summarise(prop = mean_news / (mean_news + mean_old))
# 
# function_prop = function(df){
#   
#   lastfm %>%  
#     pull(news) %>% 
#     median() /
#     
#   (lastfm %>%  
#     pull(news) %>% 
#     median() 
#   +
#   lastfm %>%  
#     pull(old) %>% 
#     median())
# }
  
function_prop = function(df){
  
  news = df %>%  
  pull(news) %>% 
  median() 

  old = df %>%  
  pull(old) %>% 
  median()

  prop = news / (news + old)

  return(prop)
}

theta_c = function_prop(lastfm)
theta_c
```

- *Bootstrap manual*
```{r}
repeticoes = 4000 # pelo menos 2000, mas mais não faz mal.

um_bootstrap <- function(df){
  boot_x <- sample_n(df,           # amostrando dados com o sample n (para data_frames)
                   size = NROW(df), # tamanho igual ao recebido
                   replace = TRUE) # aqui é o bootstrap
  return(function_prop(boot_x)) # calculando a proporção para cada sample gerado
}

set.seed(1212)

# A REAMOSTRAGEM
reamostragens = tibble(i = 1:repeticoes) %>% 
  mutate(theta_c_s = map_dbl(i, ~ um_bootstrap(lastfm)))

reamostragens
```

- *Verificando erro na dstribuição amostral* 
```{r}

intervalo = reamostragens %>% 
  mutate(erro = theta_c_s - theta_c) %>% 
  summarise(erro_i = quantile(erro, .05), 
            erro_s = quantile(erro, .95))

intervalo

```

- *Verificando intervalo de confiança*
```{r}
intervalo = intervalo %>% 
  mutate(valor_i = theta_c + erro_i, 
         valor_s = theta_c + erro_s)

intervalo
```

- *Calculando o bootstap com a biblioteca boot*
```{r}
library(boot)

lastfm %>%
    slice(10)

function_prop_2 = function(df, i){
  t = df[i,]
  
  news = t %>%  
  pull(news) %>% 
  median() 

  old = t %>%  
  pull(old) %>% 
  median()

  prop = news / (news + old)

  return(prop)
}

booted <- boot(data = lastfm, 
               statistic = function_prop_2, 
               R = 4000)

boot.ci(booted, type = "bca", conf = 0.90)

ci = tidy(booted, 
          conf.level = .95,
          conf.method = "bca",
          conf.int = TRUE)

```

### 2. Para os usuários que gostam de música muito pop (mediana_pop > 5), qual a correlação entre a popularidade mediana dos artistas escutado e a proporção dos artistas escutados que eram novos. 

```{r}

pop = lastfm %>%
    filter(mediana_pop > 5)

pop
```

```{r}
pop = pop %>% 
    mutate(proporcao_news = news / (news + old) )

pop   
```

```{r}

pop %>%
    ggplot(aes(x = mediana_pop, y = proporcao_news)) +
    geom_point()
```

```{r}
pop %>% 
    summarise(pearson = cor(mediana_pop, proporcao_news, method = "pearson"), 
            spearman = cor(mediana_pop, proporcao_news, method = "spearman"), 
            kendall = cor(mediana_pop, proporcao_news, method = "kendall"))

```


